
<!DOCTYPE html>
<html lang="th">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>จองที่นั่งรถตู้</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        text-align: center;
        padding: 16px;
        background: #f5f5f5;
      }
      .container {
        max-width: 480px;
        margin: 0 auto;
        background: #ffffff;
        padding: 16px 16px 24px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      }
      .title {
        font-size: 22px;
        margin-bottom: 6px;
      }
      .subtitle {
        font-size: 13px;
        color: #666;
        margin-bottom: 12px;
      }
      .logo {
        width: 150px;
        display: block;
        margin: 4px auto;
      }

      .field-label {
        text-align: left;
        font-size: 14px;
        margin: 8px 0 4px;
        font-weight: 600;
      }
      .field-input {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
      }
      .date-box {
        margin: 10px 0 12px;
        text-align: left;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(3, 70px);
        gap: 8px;
        justify-content: center;
        margin-top: 4px;
        margin-bottom: 8px;
      }

      /* เบาะว่าง = เขียว */
      .seat {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        border: 1px solid #444;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        background: #4CAF50;
        color: white;
        transition: 0.15s;
      }

      /* เบาะที่กำลังเลือก = เหลือง */
      .seat.selected {
        background: gold;
        color: black;
      }

      /* เบาะที่ถูกจองแล้ว (จากชีต) = แดง */
      .seat.booked {
        background: #f44336;
        color: white;
        cursor: not-allowed;
      }

      button {
        width: 100%;
        padding: 10px 16px;
        margin-top: 10px;
        border: none;
        border-radius: 8px;
        background: #1976d2;
        color: #fff;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
      }
      button:active {
        transform: scale(0.98);
      }

      .note {
        margin-top: 8px;
        font-size: 11px;
        color: #777;
      }

      .hidden {
        display: none;
      }

      .summary {
        font-size: 13px;
        margin-top: 6px;
        color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">ระบบจองที่นั่งรถตู้</h1>
      <p class="subtitle">เลือกวัน เลือกทริป เลือกเบาะ แล้วกรอกข้อมูลให้ครบ</p>

      <!-- ถ้าอยากใส่โลโก้: เปลี่ยน src ให้เป็นลิงก์รูปของไอซ์เอง -->
      <!-- <img src="https://ลิงก์โลโก้ของไอซ์" class="logo" alt="โลโก้"> -->

      <!-- วันที่เดินทาง -->
      <div class="date-box">
        <label class="field-label" for="travel_date">วันที่เดินทาง</label>
        <input
          id="travel_date"
          type="date"
          class="field-input"
        >
      </div>

      <!-- ชื่อทริป / ปลายทาง -->
      <div>
        <label class="field-label" for="trip_name">ชื่อทริป / ปลายทาง</label>
        <input
          id="trip_name"
          type="text"
          class="field-input"
          placeholder="เช่น กรุงเทพฯ - แม่ฮ่องสอน รอบเช้า"
        >
      </div>

      <!-- ผังที่นั่ง -->
      <div style="margin-top: 12px;">
        <div class="field-label">เลือกหมายเลขที่นั่ง</div>
        <div id="seatGrid" class="grid"></div>
        <p class="summary">
          วันที่: <span id="summaryDate">ยังไม่ได้เลือก</span><br>
          ทริป: <span id="summaryTrip">ยังไม่ได้กรอก</span><br>
          ที่นั่งที่เลือก: <strong id="selectedSeatLabel">ยังไม่ได้เลือก</strong>
        </p>
      </div>

      <!-- ฟอร์มข้อมูลผู้จอง -->
      <div id="formBox" class="hidden">
        <label class="field-label" for="full_name">ชื่อ-นามสกุล</label>
        <input
          id="full_name"
          type="text"
          class="field-input"
          placeholder="เช่น นายเดินป่า เที่ยวนี่เหอะ"
        >

        <label class="field-label" for="phone">เบอร์โทรศัพท์</label>
        <input
          id="phone"
          type="tel"
          class="field-input"
          placeholder="เช่น 080-000-0000"
        >

        <label class="field-label" for="line_id">ไลน์ไอดี</label>
        <input
          id="line_id"
          type="text"
          class="field-input"
          placeholder="เช่น ice0820630039"
        >

        <button id="submitBtn">ยืนยันการจอง</button>

        <p class="note">
          เมื่อกดยืนยัน ข้อมูลจะถูกบันทึกใน Google Sheet ของคุณ<br>
          เบาะที่ถูกจองแล้วในวันเดียวกันจะขึ้นเป็นสีแดง และจองซ้ำไม่ได้
        </p>
      </div>
    </div>

    <script>
      // ผังเบาะ 9 ที่นั่ง: 3 6 9 / 2 5 8 / 1 4 7
      const SEATS = [3, 6, 9, 2, 5, 8, 1, 4, 7];

      let selectedSeat = null;
      let currentDate  = "";
      let currentTrip  = "";

      // วาดผังที่นั่ง ตามลิสต์เบาะที่ถูกจองมา (bookedSeats = ["3","5",...])
      function renderSeats(bookedSeats) {
        const grid        = document.getElementById("seatGrid");
        const formBox     = document.getElementById("formBox");
        const seatLabel   = document.getElementById("selectedSeatLabel");
        const summaryDate = document.getElementById("summaryDate");
        const summaryTrip = document.getElementById("summaryTrip");

        grid.innerHTML = "";
        formBox.classList.add("hidden");
        selectedSeat = null;
        seatLabel.textContent = "ยังไม่ได้เลือก";

        summaryDate.textContent = currentDate || "ยังไม่ได้เลือก";
        summaryTrip.textContent = currentTrip || "ยังไม่ได้กรอก";

        if (!currentDate) {
          grid.innerHTML = "<p>กรุณาเลือกวันที่ก่อน</p>";
          return;
        }

        const bookedSet = new Set((bookedSeats || []).map(String));

        SEATS.forEach(num => {
          const div = document.createElement("div");
          div.className = "seat";
          div.textContent = num;
          div.dataset.seat = num;

          if (bookedSet.has(String(num))) {
            // เบาะจองแล้ว = แดง
            div.classList.add("booked");
          } else {
            // เบาะว่าง = เขียว + ให้กดเลือกได้
            div.addEventListener("click", () => selectSeat(div));
          }

          grid.appendChild(div);
        });
      }

      // เวลาเปลี่ยนวันที่ → โหลดสถานะเบาะจากหลังบ้าน
      function onDateChange() {
        const dateInput = document.getElementById("travel_date");
        currentDate = dateInput.value;

        // อัปเดตสรุปทันที
        document.getElementById("summaryDate").textContent = currentDate || "ยังไม่ได้เลือก";

        if (!currentDate) {
          renderSeats([]);
          return;
        }

        // เรียกฟังก์ชัน getBookedSeats(date) ที่ฝั่ง Code.gs
        google.script.run
          .withSuccessHandler(renderSeats)
          .getBookedSeats(currentDate);
      }

      // เวลาเปลี่ยนชื่อทริป → อัปเดตสรุปเฉย ๆ
      function onTripChange() {
        const tripInput = document.getElementById("trip_name");
        currentTrip = tripInput.value.trim();
        document.getElementById("summaryTrip").textContent = currentTrip || "ยังไม่ได้กรอก";
      }

      // เลือกเบาะ = ทำสีเหลือง + เปิดฟอร์ม
      function selectSeat(el) {
        if (el.classList.contains("booked")) return;

        document.querySelectorAll(".seat").forEach(s => {
          if (!s.classList.contains("booked")) {
            s.classList.remove("selected");
            s.style.background = "#4CAF50";
            s.style.color = "white";
          }
        });

        el.classList.add("selected");
        el.style.background = "gold";
        el.style.color = "black";

        selectedSeat = el.dataset.seat;
        document.getElementById("selectedSeatLabel").textContent = selectedSeat;
        document.getElementById("formBox").classList.remove("hidden");
      }

      // กดยืนยันการจอง
      function submitBooking(event) {
        if (event) event.preventDefault();

        const name  = document.getElementById("full_name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const line  = document.getElementById("line_id").value.trim();
        currentTrip = document.getElementById("trip_name").value.trim();

        if (!currentDate) {
          alert("กรุณาเลือกวันที่เดินทาง");
          return;
        }
        if (!currentTrip) {
          alert("กรุณากรอกชื่อทริป / ปลายทาง");
          return;
        }
        if (!selectedSeat) {
          alert("กรุณาเลือกหมายเลขที่นั่ง");
          return;
        }
        if (!name || !phone || !line) {
          alert("กรุณากรอก ชื่อ-นามสกุล / เบอร์โทร / ไลน์ ให้ครบ");
          return;
        }

        const payload = {
          date: currentDate,
          trip: currentTrip,
          seat: selectedSeat,
          name: name,
          phone: phone,
          line: line
        };

        // เรียก submitBooking(data) ฝั่ง Code.gs
        google.script.run
          .withSuccessHandler(function(result) {
            if (!result || !result.success) {
              if (result && result.error === "SEAT_TAKEN") {
                alert("ที่นั่งนี้ของวันที่เลือกถูกจองแล้วในระบบ กรุณาเลือกเบาะอื่น");
              } else if (result && result.error === "MISSING_FIELDS") {
                alert("ข้อมูลไม่ครบ กรุณากรอกให้ครบทุกช่อง");
              } else {
                alert("จองไม่สำเร็จ: " + (result && result.error ? result.error : "ไม่ทราบสาเหตุ"));
              }

              // โหลดสถานะเบาะใหม่ เผื่อมีการจองเปลี่ยนไป
              google.script.run.withSuccessHandler(renderSeats).getBookedSeats(currentDate);
              return;
            }

            alert("จองสำเร็จ! ข้อมูลถูกบันทึกใน Google Sheet แล้ว");

            // ล้างข้อมูลฟอร์ม
            document.getElementById("full_name").value = "";
            document.getElementById("phone").value     = "";
            document.getElementById("line_id").value   = "";
            selectedSeat = null;
            document.getElementById("selectedSeatLabel").textContent = "ยังไม่ได้เลือก";
            document.getElementById("formBox").classList.add("hidden");

            // โหลดสถานะเบาะใหม่ → เบาะที่จองจะกลายเป็นสีแดง
            google.script.run.withSuccessHandler(renderSeats).getBookedSeats(currentDate);
          })
          .submitBooking(payload);
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("travel_date").addEventListener("change", onDateChange);
        document.getElementById("trip_name").addEventListener("input", onTripChange);
        document.getElementById("submitBtn").addEventListener("click", submitBooking);

        // ตอนเริ่มยังไม่เลือกวัน → ขึ้นข้อความให้เลือกวันก่อน
        renderSeats([]);
      });
    </script>
  </body>
</html>
