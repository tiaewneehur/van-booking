
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>จองที่นั่งรถตู้</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
:root{ --green:#4CAF50; --red:#E53935; --yellow:#FDD835; --bg:#f2f4f7; --card:#fff; --muted:#777; --blue:#1976d2; }
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); padding:16px;}
.card{max-width:520px;margin:0 auto;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.06);}
.title{text-align:center;font-size:22px;font-weight:700;margin:2px 0 6px;}
.subtitle{text-align:center;color:var(--muted);font-size:13px;margin-bottom:12px;}
.logo{display:block;margin:8px auto 12px;max-width:220px;width:70%;}
.seat-map-img{display:block;margin:6px auto 12px;max-width:280px;width:85%;border-radius:8px;}
.field-label{font-weight:600;margin:10px 0 6px;display:block;}
.field-input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;box-sizing:border-box;font-size:15px;}
.grid{display:grid;grid-template-columns:repeat(3,90px);gap:12px;justify-content:center;margin-top:14px;margin-bottom:12px;}
.seat{width:90px; height:90px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:17px; font-weight:600; color:#fff; cursor:pointer; padding:4px; line-height:1.2; white-space:nowrap; box-shadow:0 6px 14px rgba(0,0,0,0.06); transition:transform .12s;}
.seat:hover{transform:translateY(-4px)}
.seat.empty{background:var(--green)}
.seat.booked{background:var(--red);cursor:not-allowed;transform:none;box-shadow:none}
.seat.selected{background:var(--yellow);color:#000}
.legend{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;font-size:13px;color:var(--muted)}
.legend .box{width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:middle}
.btn{display:block;width:100%;padding:12px;border-radius:10px;border:0;background:#1976d2;color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:10px}
.btn:disabled{background:#aaa; cursor:not-allowed;}
.note{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
.hidden{display:none}
@media (max-width:420px){ .grid{grid-template-columns:repeat(3,72px);gap:10px} .seat{ width:72px; height:72px; font-size:13px; padding:3px; } }
  </style>
</head>
<body>

<div class="card">
  <h1 class="title">ระบบจองที่นั่งรถตู้</h1>
  <p class="subtitle">เลือกวัน กรอกชื่อทริป เลือกเบาะ เติมข้อมูลให้ครบ</p>
  <img src="เที่ย นี่เหอะ.png" class="logo" />
  <img src="IMG_0444.jpeg" class="seat-map-img" />

  <form id="bookingForm">
    <label class="field-label">วันที่เดินทาง</label>
    <input id="date" name="date" type="date" class="field-input" required onchange="onDateChange()" />
    <label class="field-label">ชื่อทริป</label>
    <input id="trip" name="trip" type="text" class="field-input" placeholder="เช่น ผ้าห่มปก" required />
    
    <div id="seatGrid" class="grid"></div>
    <input id="seatField" name="seat" type="hidden" />

    <div id="formBox" class="hidden">
      <label class="field-label">ชื่อ-นามสกุล</label>
      <input name="name" type="text" class="field-input" required />
      <label class="field-label">ชื่อเล่น (แสดงบนผัง)</label>
      <input id="nickname" name="nickname" type="text" class="field-input" required />
      <label class="field-label">เบอร์โทรศัพท์</label>
      <input name="phone" type="tel" class="field-input" required />
      <label class="field-label">ชื่อไลน์</label>
      <input name="line" type="text" class="field-input" required />

      <label class="field-label" style="color:var(--red)">แนบรูปสลิปโอนเงิน (TTB: 442-2-61447-1)</label>
      <input type="file" class="field-input" accept="image/*" required onchange="processFile(this)">
      <input id="slipBase64" name="slipBase64" type="hidden" name="slipBase64">

      <button type="submit" id="submitBtn" class="btn">ยืนยันการจอง</button>
      <p class="note">เบาะแดง = มีคนจองแล้ว | เขียว = ว่าง</p>
    </div>
  </form>

  <div class="legend">
    <span><span class="box" style="background:var(--green)"></span>ว่าง</span>
    <span><span class="box" style="background:var(--yellow)"></span>เลือก</span>
    <span><span class="box" style="background:var(--red)"></span>จองแล้ว</span>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw7OvKq9CZ2bgRI61UpGVTCqYYSm4xSz4DcDwkwEaTXG0yfhldX34Bmnqi5m7y6cnS-/exec";
const SEATS = [3,6,9,2,5,8,1,4,7];

function processFile(el) {
  const file = el.files[0];
  const btn = document.getElementById('submitBtn');
  if(!file) return;
  btn.disabled = true; btn.textContent = "กำลังประมวลผลรูป...";
  const reader = new FileReader();
  reader.onloadend = function() {
    document.getElementById('slipBase64').value = reader.result.split(',')[1];
    btn.disabled = false; btn.textContent = "ยืนยันการจอง";
  };
  reader.readAsDataURL(file);
}

function loadBookedJSONP(date, callback) {
  const cbName = "cb_" + Date.now();
  window[cbName] = function(data){ callback(data.bookings || []); delete window[cbName]; };
  const script = document.createElement('script');
  script.src = SCRIPT_URL + "?action=read&date=" + date + "&callback=" + cbName;
  document.body.appendChild(script);
}

function renderSeats(bookedArray) {
  const grid = document.getElementById('seatGrid');
  grid.innerHTML = '';
  const bookedMap = {};
  bookedArray.forEach(b => { bookedMap[String(b.seat)] = b.nickname; });

  SEATS.forEach(n => {
    const div = document.createElement('div');
    div.className = 'seat ' + (bookedMap[n] ? 'booked' : 'empty');
    div.textContent = bookedMap[n] || n;
    if(!bookedMap[n]) div.onclick = () => {
      document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
      div.classList.add('selected');
      document.getElementById('seatField').value = n;
      document.getElementById('formBox').classList.remove('hidden');
    };
    grid.appendChild(div);
  });
}

function onDateChange() {
  const date = document.getElementById('date').value;
  if(date) loadBookedJSONP(date, renderSeats);
}

document.getElementById('bookingForm').onsubmit = async function(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = "กำลังส่งข้อมูล...";

  const formData = new FormData(this);
  const data = new URLSearchParams(formData);

  try {
    const resp = await fetch(SCRIPT_URL, { method: 'POST', body: data });
    const res = await resp.json();
    if(res.ok) {
      alert('จองที่นั่งและส่งสลิปสำเร็จ!');
      location.reload();
    } else {
      alert('ล้มเหลว: ' + res.msg);
      btn.disabled = false; btn.textContent = "ยืนยันการจอง";
    }
  } catch(err) {
    alert('สำเร็จ (โปรดตรวจสอบใน Sheet)');
    location.reload();
  }
};

renderSeats([]);
</script>
</body>
</html>
