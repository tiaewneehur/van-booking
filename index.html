
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบจองที่นั่งรถตู้</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 10px;
    background: #eef2f3;
  }

  .title { font-size: 22px; font-weight: bold; margin-bottom: 6px; }

  .logo { width: 160px; margin: 10px auto; display: block; }

  .formBox { margin-top: 15px; }
  input, select {
    display: block;
    margin: 6px auto;
    padding: 10px;
    width: 260px;
    border-radius: 8px;
    border: 1px solid #999;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(3, 70px);
    gap: 10px;
    justify-content: center;
    margin-top: 10px;
  }

  .seat {
    width: 70px; height: 70px;
    border-radius: 10px;
    border: 1px solid #444;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    cursor: pointer;
    background: #4caf50; /* เขียว */
    color: white;
  }

  .seat.booked {
    background: #d9534f; /* แดง */
    color: white;
    cursor: not-allowed;
  }

  .seat.selected {
    background: gold; /* เหลือง */
    color: black;
  }

  button {
    padding: 12px 20px;
    background: #1976d2;
    color: white;
    border: none;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1 class="title">ระบบจองที่นั่งรถตู้</h1>

<img src="logo1.png" class="logo">
<img src="logo2.png" class="logo">

<input id="date" type="date">

<div class="grid" id="seatGrid"></div>

<div class="formBox" id="formBox" style="display:none;">
  <input id="trip" placeholder="ชื่อทริป">
  <input id="name" placeholder="ชื่อ-นามสกุล">
  <input id="nickname" placeholder="ชื่อเล่น">
  <input id="phone" placeholder="เบอร์โทร">
  <input id="line" placeholder="ชื่อไลน์">
  <button id="submitBtn">ยืนยันการจอง</button>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5y4EZztdFvFhLrOSR0elHZwoTshvrpkJhI5loyiDylH_T6Bs2_QfrXqF8oawWQoMU/exec";
  const READ_URL = SCRIPT_URL + "?action=read";

  const SEATS = [3,6,9,2,5,8,1,4,7];
  let selectedSeat = null;

  // โหลดสถานะเบาะแบบ JSONP
  function loadStatus(date) {
    return new Promise((resolve) => {

      const cb = "cb_" + Date.now();
      window[cb] = (data) => {
        delete window[cb];
        resolve(data.bookings || []);
      };

      const s = document.createElement("script");
      s.src = READ_URL + "&date=" + date + "&callback=" + cb;
      s.onerror = () => resolve([]);
      document.body.appendChild(s);
    });
  }

  // วาดผังเบาะ
  function renderSeats(bookings) {
    const grid = document.getElementById("seatGrid");
    grid.innerHTML = "";
    const map = new Map();

    bookings.forEach(b => map.set(b.seat, b.nickname));

    SEATS.forEach(num => {
      const d = document.createElement("div");
      d.className = "seat";
      d.dataset.seat = num;

      if (map.has(String(num))) {
        d.classList.add("booked");
        d.textContent = map.get(String(num));
      } else {
        d.textContent = num;
        d.onclick = () => selectSeat(d);
      }

      grid.appendChild(d);
    });
  }

  // เลือกเบาะ
  function selectSeat(el) {
    document.querySelectorAll(".seat").forEach(s => s.classList.remove("selected"));
    el.classList.add("selected");
    selectedSeat = el.dataset.seat;
    document.getElementById("formBox").style.display = "block";
  }

  // เมื่อเปลี่ยนวัน
  document.getElementById("date").addEventListener("change", async () => {
    const date = document.getElementById("date").value;
    const booked = await loadStatus(date);
    renderSeats(booked);
  });

  // ส่งการจอง
  document.getElementById("submitBtn").onclick = () => {
    const date = document.getElementById("date").value;
    const trip = document.getElementById("trip").value.trim();
    const name = document.getElementById("name").value.trim();
    const nickname = document.getElementById("nickname").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const line = document.getElementById("line").value.trim();

    if (!date || !trip || !name || !nickname || !phone || !line || !selectedSeat) {
      alert("กรุณากรอกข้อมูลให้ครบ");
      return;
    }

    // ส่งแบบ form (กัน fetch error)
    const form = document.createElement("form");
    form.action = SCRIPT_URL;
    form.method = "POST";
    form.target = "_blank";

    const fields = { date, trip, seat:selectedSeat, name, nickname, phone, line };
    for (let k in fields) {
      const i = document.createElement("input");
      i.type = "hidden"; i.name = k; i.value = fields[k];
      form.appendChild(i);
    }

    document.body.appendChild(form);
    form.submit();
    form.remove();

    setTimeout(async () => {
      const booked = await loadStatus(date);
      renderSeats(booked);
    }, 1500);

    alert("ส่งการจองสำเร็จ");
  };
</script>

</body>
</html>
