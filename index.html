
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>จองที่นั่งรถตู้</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
:root{
  --green:#4CAF50; --red:#E53935; --yellow:#FDD835; --bg:#f2f4f7;
  --card:#fff; --muted:#777;
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); padding:16px;}
.card{max-width:520px;margin:0 auto;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.06);}
.title{text-align:center;font-size:22px;font-weight:700;margin:2px 0 6px;}
.subtitle{text-align:center;color:var(--muted);font-size:13px;margin-bottom:12px;}
.logo{display:block;margin:8px auto 12px;max-width:220px;width:70%;}
.seat-map-img{display:block;margin:6px auto 12px;max-width:280px;width:85%;border-radius:8px;}
.field-label{font-weight:600;margin:10px 0 6px;display:block;}
.field-input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;box-sizing:border-box;font-size:15px;}
.grid{display:grid;grid-template-columns:repeat(3,90px);gap:12px;justify-content:center;margin-top:14px;margin-bottom:12px;}

.seat{
  width:90px;height:90px;border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:17px;font-weight:600;color:#fff;cursor:pointer;padding:4px;line-height:1.2;
  white-space:nowrap;box-shadow:0 6px 14px rgba(0,0,0,0.06);transition:transform .12s;
}
.seat:hover{transform:translateY(-4px)}
.seat.empty{background:var(--green)}
.seat.booked{background:var(--red);cursor:not-allowed;transform:none;box-shadow:none}
.seat.selected{background:var(--yellow);color:#000}

.legend{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;font-size:13px;color:var(--muted)}
.legend .box{width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:6px}
.btn{display:block;width:100%;padding:12px;border-radius:10px;border:0;background:#1976d2;color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:10px}
.note{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
.hidden{display:none}

@media (max-width:420px){
  .grid{grid-template-columns:repeat(3,72px);gap:10px}
  .seat{width:72px;height:72px;font-size:13px;padding:3px}
}
  </style>
</head>
<body>

<div class="card">
  <h1 class="title">ระบบจองที่นั่งรถตู้</h1>
  <p class="subtitle">เลือกวัน กรอกชื่อทริป เลือกเบาะ เติมข้อมูลให้ครบ</p>

  <img src="เที่ย นี่เหอะ.png" alt="โลโก้" class="logo" />
  <img src="IMG_0444.jpeg" alt="ผังเบาะ" class="seat-map-img" />

  <form id="bookingForm">
    <label class="field-label" for="date">วันที่เดินทาง</label>
    <input id="date" name="date" type="date" class="field-input" required />

    <label class="field-label" for="trip">ชื่อทริป</label>
    <input id="trip" name="trip" type="text" class="field-input" placeholder="เช่น ผ้าห่มปก" required />

    <div id="seatGrid" class="grid"></div>
    <input id="seatField" name="seat" type="hidden" />

    <div id="formBox" class="hidden">
      <label class="field-label" for="name">ชื่อ-นามสกุล</label>
      <input id="name" name="name" type="text" class="field-input" placeholder="เช่น นายเดินป่า เที่ยวนี่เหอะ" required />

      <label class="field-label" for="nickname">ชื่อเล่น (จะแสดงบนผังเมื่อจองแล้ว)</label>
      <input id="nickname" name="nickname" type="text" class="field-input" placeholder="เช่น ไอซ์" required />

      <label class="field-label" for="phone">เบอร์โทรศัพท์</label>
      <input id="phone" name="phone" type="tel" class="field-input" placeholder="เช่น 080-000-0000" required />

      <label class="field-label" for="line">ชื่อไลน์</label>
      <input id="line" name="line" type="text" class="field-input" placeholder="เช่น เที่ยวนี่เหอะ" required />

      <!-- กล่องธนาคาร + สลิป -->
      <div class="bank-box" style="border:2px dashed #1976d2;border-radius:12px;padding:15px;margin:15px 0;background:#f7fbff;text-align:center;">
        <p style="margin:5px 0;font-size:15px;font-weight:600;">
          ธนาคารทหารไทยธนชาต (TTB)
        </p>
        <p style="font-size:26px;color:#d32f2f;font-weight:800;margin:8px 0;">
          442-2-61447-1
        </p>
        <p style="margin:5px 0;">ชื่อบัญชี: วิชาญ นาคะลัย</p>

        <label class="field-label" style="text-align:left;margin-top:12px;">
          ยอดเงินโอน (บาท)
        </label>
        <input type="text" name="amount" class="field-input"
               value="1000" readonly
               style="background:#eee;text-align:center;font-weight:bold;">

        <span style="color:#d32f2f;font-weight:700;display:block;margin-top:15px;margin-bottom:8px;">
          แนบรูปสลิปการโอนเงิน *
        </span>
        <input type="file" id="slipFile" class="field-input" accept="image/*" required>
        <input type="hidden" id="slipBase64" name="slipBase64">
      </div>

      <button type="submit" id="submitBtn" class="btn">ยืนยันการจอง</button>
      <p class="note">เบาะสีแดง = จองแล้ว (แสดงชื่อเล่น) • เขียว = ว่าง • เหลือง = กำลังเลือก</p>
    </div>
  </form>

  <div class="legend">
    <span><span class="box" style="background:var(--green)"></span>ว่าง</span>
    <span><span class="box" style="background:var(--yellow)"></span>กำลังเลือก</span>
    <span><span class="box" style="background:var(--red)"></span>จองแล้ว</span>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw7OvKq9CZ2bgRI61UpGVTCqYYSm4xSz4DcDwkwEaTXG0yfhldX34Bmnqi5m7y6cnS-/exec";
const READ_URL = SCRIPT_URL + "?action=read";
const SEATS = [3,6,9,2,5,8,1,4,7];

/* ---------- แปลงรูปเป็น base64 (กัน error) ---------- */
const slipInput = document.getElementById('slipFile');
if (slipInput) {
  slipInput.addEventListener('change', function(){
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(){
      const h = document.getElementById('slipBase64');
      if (h) h.value = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ---------- JSONP โหลดเบาะ ---------- */
function loadBookedJSONP(date, cb){
  if (!date) { cb([]); return; }
  const name = "cb_" + Date.now();
  window[name] = d => { cb(d.bookings || []); delete window[name]; };
  const s = document.createElement('script');
  s.src = READ_URL + "&date=" + encodeURIComponent(date) + "&callback=" + name;
  document.body.appendChild(s);
}

/* ---------- render ผังเบาะ ---------- */
function renderSeats(booked){
  seatGrid.innerHTML = '';
  seatField.value = '';
  formBox.classList.add('hidden');
  const map = {};
  booked.forEach(b => map[b.seat] = b.nickname);

  SEATS.forEach(n => {
    const d = document.createElement('div');
    d.className = 'seat ' + (map[n] ? 'booked' : 'empty');
    d.textContent = map[n] || n;
    if (!map[n]) {
      d.onclick = () => {
        document.querySelectorAll('.seat').forEach(x => x.classList.remove('selected'));
        d.classList.add('selected');
        seatField.value = n;
        formBox.classList.remove('hidden');
      };
    }
    seatGrid.appendChild(d);
  });
}

date.onchange = () => loadBookedJSONP(date.value, renderSeats);
document.addEventListener('DOMContentLoaded', () => renderSeats([]));

/* ---------- submit (กันกดซ้ำ) ---------- */
bookingForm.onsubmit = e => {
  e.preventDefault();
  if (submitBtn.disabled) return;

  if (!slipBase64.value) {
    alert('กรุณาแนบสลิปก่อนยืนยันการจอง');
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = 'กำลังบันทึก...';

  fetch(SCRIPT_URL, {
    method: 'POST',
    body: new URLSearchParams(new FormData(bookingForm))
  })
  .then(() => {
    alert('จองสำเร็จแล้ว');
    location.reload();
  })
  .catch(() => {
    alert('เกิดข้อผิดพลาด');
    submitBtn.disabled = false;
    submitBtn.textContent = 'ยืนยันการจอง';
  });
};
</script>

</body>
</html>
